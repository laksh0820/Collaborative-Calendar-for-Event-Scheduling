{% extends 'base.html' %}

{% block extra_header %}
{% endblock %}

{% block content %}
<br>
<div class="container mt-5 pb-2" style="width: 70%;">
    <form id="profileSettingsForm" action='/user_profile' method="POST" class="shadow p-3 mb-5 bg-body rounded">
        <legend>Profile Settings</legend>
        {{ form.hidden_tag() }}

        {{ form.name.label(class="form-label") }}
        {{ form.name(class="form-control",value=name) }}
        <br />

        {{ form.email.label(class="form-label") }}
        {{ form.email(class="form-control",value=email, id="email") }}
        <div id="email-feedback" class="invalid-feedback"></div>
        <br />

        {{ form.password.label(class="form-label") }}
        {{ form.password(class="form-control", id="Password") }}
        <div id="password-feedback" class="invalid-feedback"></div>
        <br />
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="togglePassword">
            <label class="form-check-label" for="togglePassword">
                <p class="text-success">Show Password</p>
            </label>
        </div>

        {{ form.save_changes(class="btn btn-secondary" , id="save_changes_button") }}
        {{ form.cancel_changes(class="btn btn-secondary" , id="cancel_changes_button") }}

    </form>
</div>

<script>
    // Redirect to calendar page 
    document.getElementById('cancel_changes_button').addEventListener('click', (e) => {
        e.preventDefault();
        window.location.href = "{{ url_for('get_calendar') }}";
    });
    
    const togglePassword = document.querySelector('#togglePassword');
    const password = document.querySelector('#Password');
    togglePassword.addEventListener('click', () => {
        // Toggle the type attribute using getAttribure() method
        const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
        password.setAttribute('type', type);
    });

    const email = document.querySelector('#email');
    function validateEmail() {
        // Email validation regex according to RFC 5322
        const emailRegex = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        const isValidEmail = emailRegex.test(email.value);

        if (!isValidEmail) {
            email.classList.add('is-invalid');
            document.getElementById('email-feedback').textContent = "Invalid email address";
        } else {
            email.classList.remove('is-invalid');
            document.getElementById('email-feedback').textContent = '';
        }

        return isValidEmail;
    }
    email.addEventListener('input', validateEmail);

    function checkPassword(password) {
        const minLength = 8;
        const hasMinLength = password.length >= minLength;
        const hasDigit = /\d/.test(password);
        const hasLowercase = /[a-z]/.test(password);
        const hasUppercase = /[A-Z]/.test(password);
        const hasSpecialChar = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);

        return {
            isValid: hasMinLength && hasDigit && hasLowercase && hasUppercase && hasSpecialChar,
            hasMinLength,
            hasDigit,
            hasLowercase,
            hasUppercase,
            hasSpecialChar
        };
    };

    function updateDisplay(password, validation) {
        if (!validation.hasMinLength) {
            password.classList.add('is-invalid');
            document.getElementById('password-feedback').textContent = 'Password must be at least 8 characters';
        }
        else if (!validation.hasDigit) {
            password.classList.add('is-invalid');
            document.getElementById('password-feedback').textContent = 'Password must have atleast one digit';
        }
        else if (!validation.hasLowercase) {
            password.classList.add('is-invalid');
            document.getElementById('password-feedback').textContent = 'Password must have atleast one lowercase character';
        }
        else if (!validation.hasUppercase) {
            password.classList.add('is-invalid');
            document.getElementById('password-feedback').textContent = 'Password must have atleast one uppercase character';
        }
        else if (!validation.hasSpecialChar) {
            password.classList.add('is-invalid');
            document.getElementById('password-feedback').textContent = 'Password must have atleast one special character';
        }
        else {
            password.classList.remove('is-invalid');
            document.getElementById('password-feedback').textContent = '';
        }
    };

    function validatePassword() {
        const validation = checkPassword(password.value);
        updateDisplay(password, validation);
        return validation.isValid;
    }

    password.addEventListener('input', validatePassword);

    // Form submission handler
    const form = document.querySelector('#profileSettingsForm');
    form.addEventListener('submit', function (event) {
        // Validate all fields before submission
        const isValidEmail = validateEmail();
        const isPasswordValid = validatePassword();

        if (!isValidEmail || !isPasswordValid) {
            event.preventDefault();
            event.stopPropagation();
        }
    });
</script>

{% endblock %}